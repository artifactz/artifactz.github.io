<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" type="image/png" href="media/favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<script src="https://cdn.jsdelivr.net/npm/msgpackr@1.11.0/dist/index.min.js"></script>

<div class="wrapper">

<header>
  <h1>eyeGuide</h1>
</header>

<div class="modal-box">

<div id="status">Select pdf file</div>
<hr class="formsep">

<form id="upload-form">
  <div style="height: 1em"></div>
  <input id="file-input" type="file" name="file" style="display:block" accept=".pdf">
  <div style="height: 1em"></div>
  <div class="disclaimer">Your document is processed by Google servers in Germany, EU. We do not store the document. Google Cloud automatically logs request metadata, including IP addresses and timestamps, for security and operational purposes.</div>
  <div style="height: 1em"></div>
  <input type="submit" value="Accept">
</form>

<div id="upload-spinner" style="display: none">
  <img class="loading-spinner" src="media/spinner.gif">
</div>

<form id="upload-result-form" style="display: none">
  <table>
    <tr>
      <td>
        <img id="result-icon-ok" style="height: 3em; display: none;" src="media/done.png">
        <img id="result-icon-warn" style="height: 3em; display: none;" src="media/warning.png">
        <img id="result-icon-err" style="height: 3em; display: none;" src="media/error.png">
      </td>
      <td style="padding-left: 1em">
        <div id="result-text"></div>
      </td>
    </tr>
  </table>
  <input type="submit" class="restart-button" value="Select another file">
</form>

</div>
</div>

<div class="floating-footer">
<a href="index.html">Back to artifactz</a>
</div>

<script src="secret.js"></script>
<script>
document.getElementById("upload-form").addEventListener("submit", async function(event) {
  event.preventDefault();

  let formData = new FormData();
  let fileInput = document.getElementById("file-input");
  if (fileInput.files.length === 0) {
    alert("Please select a file");
    return;
  }

  let form = document.getElementById("upload-form");
  let spinner = document.getElementById("upload-spinner");
  let result = document.getElementById("upload-result-form");
  let status = document.getElementById("status");
  let height = form.clientHeight + "px";

  spinner.style.height = height;
  form.style.display = "none";
  spinner.style.display = "block";

  let uploadFile = fileInput.files[0];
  status.innerHTML = "Processing " + uploadFile.name;
  formData.append("file", uploadFile);

  let response = await fetch("https://europe-west10-eye-guide.cloudfunctions.net/pdf_proxy", {
    method: "POST",
    body: formData
  });

  if (response.ok) {
    let decoder = new msgpackr.Decoder();
    let msg = decoder.decode(new Uint8Array(await response.arrayBuffer()));

    updateResult(msg.get("metadata"));

    let blob = new Blob([msg.get("pdf")], { type: "application/pdf" });
    let downloadFileName = uploadFile.name.slice(0, -4) + " (eyeGuide).pdf";
    let downloadLink = document.createElement("a");
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = downloadFileName;
    downloadLink.click();

  } else {
    updateResult(null);
  }

  result.style.height = height;
  spinner.style.display = "none";
  result.style.display = "block";
  status.innerHTML = "Completed " + uploadFile.name;
});


/**
 * Restart button.
 */
document.getElementById("upload-result-form").addEventListener("submit", async function(event) {
  event.preventDefault();

  document.getElementById("file-input").value = null;
  document.getElementById("upload-result-form").style.display = "none";
  document.getElementById("upload-form").style.display = "block";
  document.getElementById("status").innerHTML = "Select pdf file";
});

function updateResult(metadata) {
  let resultText = document.getElementById("result-text");
  if (!metadata) {
    updateResultIcon("error");
    resultText.innerHTML = "Error processing the file";
  } else {
    let summary = metadata.get("summary");
    let successRatio = metadata.get("success_ratio");
    let text = "";
    if (metadata.get("has_encrypted_fonts")) {
      text = (
        (successRatio < 0.5) ?
        "<p>Your uploaded document has encrypted fonts. There's nothing we can do. Sorry!</p>" :
        "<p>Your uploaded document has encrypted fonts. We did our best, but there might be missing sections. Sorry!</p>"
      );
    } else {
      text = (
        (successRatio < 0.5) ?
        "<p>There might be missing sections due to font (licensing) issues. You can submit PDF files you're having " +
          "issues with per email to <a id=\"address\" target=\"_blank\"></a> or create an " +
          "<a href=\"https://github.com/artifactz/eye-guide/issues\" target=\"_blank\">issue</a> at GitHub.</p>" :
        "<p>Your document is now easier to read. ðŸš€</p>"
      );
    }
    text += "<p>Word coverage: " + (successRatio * 100).toFixed(0) + "%</p>"
    resultText.innerHTML = text;
    makeEmailLink("address");
    updateResultIcon(summary);
  }
}

function updateResultIcon(status) {
  let icoOK = document.getElementById("result-icon-ok");
  let icoWarn = document.getElementById("result-icon-warn");
  let icoErr = document.getElementById("result-icon-err");
  icoOK.style.display = "none";
  icoWarn.style.display = "none";
  icoErr.style.display = "none";
  if (status == "ok") {
    icoOK.style.display = "block";
  } else if (status == "warning") {
    icoWarn.style.display = "block";
  } else {
    icoErr.style.display = "block";
  }
}
</script>


</body>
</html>
